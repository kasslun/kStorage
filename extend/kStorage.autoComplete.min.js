/*!
 * 本地自动完成
 * 开发日期: 13-11-15
 * 依赖:本地存储框架kStorage
 * https://github.com/kasslun/kStorage
 */
!function(t){"use strict"
    if(t.kst&&t.kst.support&&"off"!==t.kst.autocomplete){var e,i,s,o=t.kst||t.kStorage,n=t.document,a=n.getElementsByTagName("html")[0],l=n.getElementsByTagName("body")[0],h=o.use("_autoCompleteData",360),c=1e3,r=String.prototype.trim?function(t){return String.prototype.trim.call(t)}:function(t){return t.replace(/^[\s\uFEFF\xA0]+|[\s\uFEFF\xA0]+$/g,"")},u=n.addEventListener?function(t,e,i){t.addEventListener(e,i)}:function(t,e,i){t.attachEvent("on"+e,function(){i.call(t)})},f=function(t){var e,i=t.style.cssText||""
        return t.style.cssText=i+";border-bottom-width:0;",e=t.offsetHeight,t.style.cssText=i,t.offsetHeight!==e},d=function(t){t.preventDefault?t.preventDefault():t.returnValue=!1}
        e="userData"===o.type,i=e&&parent.location===t.location,s={init:function(){this.createDom(),this.findInput(),this.positionChangeEvent()},createDom:function(){var i=this,s=this.box=document.createElement("div"),o=this.inner=document.createElement("div")
            s.id="kst-localautocomplete",e&&(s.innerHTML='<iframe scrolling="no"></iframe>',o.className="kst-localautocomplete-inner"),s.appendChild(o),l.appendChild(s),u(s,"mouseover",function(e){var s,o,n=e||t.event,a=n.target||n.srcElement,l=a.tagName
                "DIV"!==l&&("SPAN"!==l&&(a=a.parentNode),s=i.list,o=i.index,s[o]&&(s[o].className=""),a.className="kst-localautocomplete-checked",i.index=a.getAttribute("index")-0)}),u(s,"mousedown",function(t){t?t.preventDefault():i.isDown=!0}),u(s,"mouseup",function(e){var s=e||t.event,o=s.target||s.srcElement,n=i.currEle,a=i.index
                return"A"===o.tagName?(i.removeData(a),n.focus(),void 0):(n.value=i.text[a],i.hideBox(),void 0)})},findInput:function(){function e(){m.isEffective(this)&&(m.currEle=this,m.data=h.get("data")||[])}function i(){if(m.isEffective(this)){if(m.isDown)return this.focus(),m.isDown=!1,void 0
            var t=r(this.value),e=t.length
            e>1&&21>e&&this.data&&m.updateData(t),m.hideBox()}}function s(e){var i,s,o,n,a=e||t.event
            if(m.isEffective(this)&&m.isShow)switch(i=a.keyCode,s=m.list,o=m.index,n=m.size,i){case 40:s[o].className="",s[m.index=(o+1)%n].className="kst-localautocomplete-checked",d(a)
                break
                case 38:s[o].className="",s[m.index=(o-1+n)%n].className="kst-localautocomplete-checked",d(a)
                    break
                case 13:this.value=m.text[o],m.hideBox()}}function o(e){if(m.isEffective(this)&&13!==(e||t.event).keyCode&&m.valueCache!==this.value){m.valueCache=this.value
            var i,s,o,n,a,l,h,c,r,u,f,d,p=m.currEle
            if(p){if(n=p.value){for(a=[],l=[],r=[],u=[],i=m.data,h=0,c=0,s=0,o=i.length;o>s&&10>h;s++)f=i[s],f!==n&&(d="<span>"+f.replace(n,"<em>"+n+"</em>")+'<a href="javascript:;" hidefocus="true"></a></span>',0===f.indexOf(n)?(h++,r.push(f),a.push(d)):f.indexOf(n)>0&&(c++,u.push(f),l.push(d)))
                if(h+c)return 9>h&&(a=a.concat(l),r=r.concat(u)),m.text=r,m.showBox(a),void 0}m.hideBox()}}}var a,l,c,f,p,m=this,v=n.getElementsByTagName("input")
            for(a=0,l=v.length;l>a;a++)f=v[a],c=f.getAttribute("type"),p=f.getAttribute("autocomplete"),c&&"text"!==c.toLowerCase()||p&&"off"===p.toLowerCase()||(f.setAttribute("autocomplete","off"),u(f,"focus",e),u(f,"blur",i),u(f,"keydown",s),u(f,"keyup",o))},isEffective:function(t){return!t.getAttribute("readonly")&&!t.getAttribute("disabled")},updateData:function(t){var e,i=this.data,s=i.length
            for(e=0;s>e;e++)if(i[e]===t){i.splice(e,1)
                break}i.unshift(t),i.length>c&&(i.length=c),h.set("data",i)},showBox:function(t){var e,i,s,o=this.box,n=this.inner,a=n.className||"",l=this.setLayout(t.length)
            if(l.size){for(this.size=t.length=l.size,n.innerHTML=t.join(""),e=this.list=n.getElementsByTagName("span"),i=0,s=this.size;s>i;i++)e[i].setAttribute("index",i+"")
                e[0].className="kst-localautocomplete-checked",n.className=a+" kst-localautocomplete-auto",o.style.width="",o.style.width=Math.max(n.offsetWidth,l.width)+"px",n.className=a,this.index=0,this.isShow=!0}},hideBox:function(){this.isShow&&(this.box.style.left="-99999999px",this.isShow=!1,this.valueCache=void 0)},setLayout:function(t){var e,s=this.getEeferenceEle(this.currEle),o=this.box,n=i?2:0,h=2,c=25,r=252,u=275,f=s.offsetHeight,d=s.offsetWidth,p=s.getBoundingClientRect(),m=p.top-n+(a.scrollTop||l.scrollTop),v=Math.max.apply(null,[a.clientHeight&&a.scrollHeight,l.clientHeight,l.scrollHeight,a.clientHeight])-m-f,g=p.left-n+(a.scrollLeft||l.scrollLeft),x=Math.max.apply(null,[a.clientWidth&&a.scrollWidth,l.clientWidth,l.scrollWidth,a.clientWidth])-g-d,y=Math.min(10,t)
            return v>r?(e=m+f,this.showTop=!1):m>r?(e=m-y*c-h,this.showTop=!0):m>v?(y=Math.min(Math.floor(m/c),t),e=m-y*c-h,this.showTop=!0):(y=Math.min(Math.floor(v/c),t),e=m+f,this.showTop=!1),y&&(x+d>u?(o.style.left=g+"px",o.style.right="auto"):(o.style.left="auto",o.style.right=x+"px"),o.style.top=e+"px",o.style.height=y*c+"px"),{size:y,width:s.offsetWidth-h}},getEeferenceEle:function(t){var e=0
            if(f(t))return t
            for(;3>e;e++)if(t=t.parentNode,f(t))return t
            return t},removeData:function(t){var e,i,s,o=this.data,n=this.list,a=this.text[t],l=this.size=this.size-1
            if(l){for(this.inner.removeChild(n[t]),this.box.style.height=25*l+"px",this.index>=l&&this.index--,e=this.index,n[e].className="kst-localautocomplete-checked",i=t;l>i;i++)n[i].setAttribute("index",i+"")
                this.showTop&&this.setLayout(l)}else this.hideBox()
            for(this.text.splice(t,1),i=0,s=o.length;s>i;i++)if(o[i]===a){o.splice(i,1)
                break}h.set("data",o)},positionChangeEvent:function(){var e,i,s=this
            u(t,"resize",function(){if(s.isShow){var t=window.innerWidth||a.clientWidth||l.clientWidth,o=window.innerHeight||a.clientHeight||l.clientHeight;(e!==t||i!==o)&&(e=t,i=o,s.hideBox())}}),u(t,"scroll",function(){s.isShow&&s.setLayout(s.size)})}},u(t,"load",function(){setTimeout(function(){s.init()},500)})}}(window)